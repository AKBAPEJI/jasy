#!/usr/bin/env python3

import sys, os, logging

# Extend PYTHONPATH with 'lib'
sys.path.insert(0, os.path.normpath(os.path.join(os.path.dirname(os.path.abspath(sys.argv[0])), os.pardir, "lib")))

from jasy.parser.Parser import parse
from jasy.parser.ScopeScanner import scan

from jasy.core.Permutation import Permutation
from jasy.output.Compressor import compress

from jasy.cleaner import DeadCode
from jasy.cleaner import Unused

from jasy.optimizer import CombineDeclarations
from jasy.optimizer import LocalVariables
from jasy.optimizer import CryptPrivates
from jasy.optimizer import BlockReducer



if __name__ == "__main__":
    # TODO: get from args
    level = logging.DEBUG
    values = None
    
    # Run
    logging.getLogger().setLevel(level)

    for fname in sys.argv[1:]:
        text = open(fname, encoding="utf-8").read()
        tree = parse(text, fname)
    
        if values:
            Permutation(values).patch(tree)

        DeadCode.cleanup(tree)
        Unused.optimize(tree)
        
        CombineDeclarations.optimize(tree)
        BlockReducer.optimize(tree)
        LocalVariables.optimize(tree)
        CryptPrivates.optimize(tree)
    
        print(compress(tree))
