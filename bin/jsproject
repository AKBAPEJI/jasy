#!/usr/bin/env python3

# Extend PYTHONPATH with 'lib'
import sys, os
sys.path.insert(0, os.path.normpath(os.path.join(os.path.dirname(os.path.abspath(sys.argv[0])), os.pardir, "lib")))

# Import JavaScript tooling
from api import *
import time, logging

start = time.time()

# Application specific code
session = Session()
session.addProject(Project("/Users/Sebastian/Workspace/qooxdoo/qooxdoo/framework"))
session.addProject(Project("/Users/Sebastian/Workspace/qooxdoo/qooxdoo/component/apiviewer"))
session.addProject(Project("/Users/Sebastian/Workspace/unify/framework"))

# Simple command line support
if len(sys.argv) > 1:
    cmd = sys.argv[1]
    
    if cmd == "-c":
        logging.info("Clearing cache...")
        session.clearCache()

            

# Locale data
session.addLocale("en_US")
#session.addLocale("de_DE")

# Variant data
session.addVariant("qx.debug", [ "off" ])
#session.addVariant("qx.client", [ "webkit", "gecko", "mshtml" ])

for permutation in session.getPermutations():
    hashed = permutation.getHash()
    logging.info("Permutation: %s" % permutation)
    
    # Resolving dependencies
    resolver = JsResolver(session, permutation)
    resolver.addClassName("qx.core.Object")
    #resolver.addClassName("qx.ui.window.Window")
    #resolver.addClassName("apiviewer.Application")
    classes = resolver.getIncludedClasses()

    # Sorting classes
    sorter = JsSorter(classes, permutation)
    sortedClasses = sorter.getSortedClasses()

    # Compiling classes
    compressor = JsCompressor(sortedClasses, permutation)
    compressor.compress("main-%s.js" % hashed)




# Info
logging.info("Runtime: %ims" % ((time.time()-start)*1000))

# Close session
session.close()